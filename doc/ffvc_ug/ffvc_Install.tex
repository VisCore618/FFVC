%%
\section{MPIライブラリのインストール}

OpenMPI\footnote{http://www.open-mpi.org/}のインストールについて説明します．

\begin{enumerate}
\item autotoolsによるコンパイル\\
autotools~\cite{autotools}を用いて作成されたパッケージは容易にインストールができます．
典型的な場合，インストールまでの全工程が自動化され，ソースコードを展開した後，以下のコマンドを入力するだけで全てが完了します．
{\small
\begin{program}
./configure && make && make install
\end{program}
}

この時点で\verb|autotools|のバージョンが違う場合には以下のコマンドを実行し，環境を合わせます．

{\small
\begin{program}
$ aclocal
$ autoconf
$ automake -a
\end{program}
}

\item シェルスクリプトを用いたコンパイル環境の設定\\
configureのために，次のようなスクリプトを用意して実行します．
インストールディレクトリは\verb|/opt/openmpi|とします．
コンパイラは，Intel Compiler icpc/ifortの利用を指定しています．

{\small
\begin{program}
$ cat config_ompi.sh

#!/bin/sh
export CC=icc
export CFLAGS=-O3
export CXX=icpc
export CXXFLAGS=-O3
export F77=ifort
export FFLAGS=-O3
export FC=ifort
export FCFLAGS=-O3
#
./configure --prefix=$1

$ ./config_ompi.sh /opt/openmpi
\end{program}
}

\item コンパイルの実行とインストール\\
{\small
\begin{program}
$ make
$ sudo make install
\end{program}
}

\item PATHの設定\\
実行時のmpirun\footnote{mpiexecでも動きます．}が正しいパスになっているかどうかをwhichコマンドで確認します\footnote{Mac OSXの場合にはデフォルトでインストールされているOpenMPIの方を見に行くので，インストールしたOpenMPIのPATHを最初の方に書いておきます．}．

{\small
\begin{program}
$ which mpirun
\end{program}
}

\item 環境変数の設定\\
実行時に必要な環境変数をホームディレクトリの\verb|.bash_profile|などに記述しておきます．

{\small
\begin{program}
export LD_LIBRARY_PATH=/opt/openmpi/lib:$LD_LIBRARY_PATH
export DYLD_LIBRARY_PATH=/opt/openmpi/lib:$DYLD_LIBRARY_PATH
\end{program}
}

\end{enumerate}



%
\section{textparserのインストール}

MPI通信ライブラリのインストールの後に，textparserをインストールします．
インストールの詳細は，textparserのINSTALLをご覧ください．
幾つかのインストール方法がありますが，ここではconfigureを使った方法を説明します．

%
\subsection{configureによるコンパイル環境の設定}

{\small
\begin{program}
$ cat config_tp.sh
$ ./configure --prefix=$1 \
              CXX=mpicc \
	      --enable-mpi
	    
$ config_tp.sh /usr/local/textparser
\end{program}
}

上記の例では，textparserライブラリを\verb|/usr/local/textparser|にインストールします．



%
\section{CPMlibのインストール}

CPMlibのインストールを行います．

%
\subsection{configureを用いたコンパイル環境の設定}
まず，\verb|configure|の設定を行います．
次のスクリプトの例では，インストールディレクトリを\verb|/usr/local/cpm_float/|に指定，既にインストールしたMPIライブラリとtextparserライブラリのインストールディレクトリパスを指定しています．
もし，\verb|/usr/local/|領域へのアクセス権限がない場合には，各ユーザが書き込める場所を指定します．
インストールの詳細はCPMlibのINSTALLをご覧ください．

{\small
\begin{program}
$ cat config_cpm_float.sh
$ ./configure --prefix=$1 \
              --with-comp=INTEL \
              --with-ompi=/opt/openmpi \
              --with-parser=/usr/local/textparser \
              --with-real=float \
              CXX=icpc \
              CXXFLAGS=-O3 \
              FC=ifort
\end{program}
}

上記のインストールシェルは，引数としてインストールディレクトリを指定し，次のように実行します．


\verb|configure|により，利用者の環境を調査し，適切なコンパイル環境を設定します．

{\small
\begin{program}
$ config_cpm_float.sh /usr/local/cpm_float
\end{program}
}

%
\subsection{モジュールの作成とインストール}
\verb|configure|の後，次のコマンドを実行します．

{\small
\begin{program}
$ make
$ sudo make install　または　make install
\end{program}
}

make時に\verb|libimf.so|が見つからないなどのメッセージが出る場合は，ホームディレクトリの\verb|.bash_profile|などにコンパイラのLD\_LIBRARY\_PATHパスを加えておきます．
{\small
\begin{program}
export LD_LIBRARY_PATH=/opt/intel/Compiler/11.1/089/lib:$LD_LIBRARY_PATH
\end{program}
}


%
\subsection{倍精度計算モジュール}
単精度計算と倍精度計算では，それぞれ専用のCMPlibライブラリが必要になり，単精度計算と倍精度計算で異なる精度のモジュールを別々に用意します．
倍精度計算モジュールを生成する場合には，configure時に\verb|--with-real=double|オプションを追加してください．


%
\section{関連ライブラリのビルド}

FFV-Cに必要なPMlib, Polylib, Cutlibライブラリをビルドします．
各ライブラリのsrcディレクトリに入り，下記を実行します．
各ライブラリのlibディレクトリにアーカイブが生成されます．

{\small
\begin{program}
$ make clean
$ make depend
$ make
\end{program}
}



%%
\hypertarget{tgt:installFFV-C}{\section{FFV-Cソルバーのインストールとコンパイル}}

本節では，ソルバークラスのインストールについて説明します．
提供されるソルバークラスのアーカイブ\verb|ffvc-x.x.x.tar.gz|は，ソルバークラスのソースコードです\footnote{ffvc-x.x.x.tar.gzのx.x.xにはリリースバージョン番号が入ります．}．

%%
\subsection{アーカイブの解凍}
{\small
\begin{program}
$ tar xvfz ffvc-x.x.x.tar.gz
\end{program}
}

解凍すると，以下のようなファイル構成になります\footnote{doxygenディレクトリについては，doxygenファイルを生成するために必要な設定ファイルのみを提供しています．Confディレクトリ内でmakeを実行すると各ディレクトリにdoxygenファイルが生成されます．}．

{ \small
\begin{program}
ffvc-x.x.x
  |
  +- BUILD                        アプリケーションのコンパイル方法のメモ
  +- COPYING                      コピーライト
  +- README                       最初に見るべきファイル
  +- RELEASE                      リリース情報
  |
  +- bin                          
  |   +- ffvc                     実行モジュール
  |
  +- doc                          ドキュメント
  |   +- ffvc_ug.pdf              FFV-Cソルバーのユーザガイド
  |   
  |
  +- doxygen                      Doxygenドキュメントディレクトリ
  |   +- FFV                      FFVクラスのドキュメント
  |   +- Conf                     Doxygenファイルを生成するための設定ファイル
  |   +- FB                       FBクラスのドキュメント
  |   +- IP                       Intrinsicクラスのドキュメント
  |
  +- example                      例題
  |   +- 3Dcavity                 三次元のキャビティフロー（立方体領域）
  |   +- PMT                      性能測定用パラメータ群
  |   +- SHC1D                    定常1次元熱伝導
  |
  +- src                          ソースコード
      +- Cutlib-x.x.x             カットライブラリ
      +- FB                       FlowBaseクラス（ユーザー定義クラス群）
      +- FFV                      FFV-CソルバのFortranファイル
      +- F_CDS                    CPCクラスのFortranファイル
      +- F_CORE                   Fortranのコアプログラム（Binary版）
      +- F_VOF                    VOFクラスのFortranファイル
      +- IP                       組み込み例題クラス群
      +- PMlib_x.x	             性能測定ライブラリ
      +- Polylib-x.x.x             ポリゴン管理ライブラリ

\end{program}
}
%  |   +- Inside_FFV-C.pdf           FFV-Cソルバーの説明書

