%%
\section{MPIライブラリのインストール}
\label{sec:install MPI}

OpenMPI\footnote{http://www.open-mpi.org/}のインストールについて説明します．

\begin{enumerate}
\item autotoolsによるコンパイル\\
autotools~\cite{autotools}を用いて作成されたパッケージは容易にインストールができます．
典型的な場合，インストールまでの全工程が自動化され，ソースコードを展開した後，以下のコマンドを入力するだけで全てが完了します．
{\small
\begin{program}
./configure && make && make install
\end{program}
}

\item シェルスクリプトを用いたコンパイル環境の設定\\
configureのために，次のようなスクリプトを用意して実行します．
インストールディレクトリは\verb|/usr/local/openmpi|とします．
コンパイラは，Intel Compiler icpc/ifortの利用を指定しています．

{\small
\begin{program}
$ cat config_ompi.sh

#!/bin/sh
export CC=icc
export CFLAGS=-O3
export CXX=icpc
export CXXFLAGS=-O3
export F77=ifort
export FFLAGS=-O3
export FC=ifort
export FCFLAGS=-O3
#
./configure --prefix=$1

$ ./config_ompi.sh /usr/local/openmpi
\end{program}
}

\item コンパイルの実行とインストール\\
{\small
\begin{program}
$ make
$ sudo make install
\end{program}
}

\item PATHの設定\\
実行時のmpiexec\footnote{mpirunでも動きます．}が正しいパスになっているかどうかをwhichコマンドで確認します\footnote{Mac OSXの場合には上記のように，デフォルトでインストールされているOpenMPIの方を見に行くので，インストールしたOpenMPIのPATHを最初の方に書いておきます．}．

{\small
\begin{program}
$ which mpiexec
\end{program}
}

\item 環境変数の設定\\
実行時に必要な環境変数をホームディレクトリの\verb|.bash_profile|などに記述しておきます．

{\small
\begin{program}
export LD_LIBRARY_PATH=/usr/local/openmpi/lib:$LD_LIBRARY_PATH
export DYLD_LIBRARY_PATH=/usr/local/openmpi/lib:$DYLD_LIBRARY_PATH
\end{program}
}

\end{enumerate}

%
\section{V-Sphereのインストール}
\label{sec:install vsphere}
V-Sphereのインストールは，MPI通信ライブラリのインストールの後に行います．

%
\subsection{autotoolsを用いたコンパイル環境の設定}
まず，\verb|configure|の設定を行います．
次のスクリプトの例では，インストールディレクトリを\verb|/usr/local/sphere/|に指定しています．
もし，\verb|/usr/local/|領域へのアクセス権限がない場合には，各ユーザが書き込める場所を指定します．
また，LDFLAGSには，コンパイラへの適切なパスを指定します．

{\small
\begin{program}
$ cat configure.sh
$ ./configure --prefix=$1 \
              --with-comp=INTEL \
              --with-ompi=/usr/local/openmpi \
              CC=icc \
              CFLAGS=-O3 \
              CXX=icpc \
              CXXFLAGS=-O3 \
              FC=ifort \
              FCFLAGS=-O3 \
              F90=ifort \
              F90FLAGS=-O3 \
              LDFLAGS=-L/opt/intel/Compiler/11.1/089/lib/intel64
\end{program}
}

上記のインストールシェルは，引数としてインストールディレクトリを指定し，次のように実行します．
この時点で\verb|autotools|のバージョンが違う場合には以下のコマンドをV-Sphereディレクトリで実行し，環境を合わせます．

{\small
\begin{program}
$ aclocal
$ autoconf
$ automake -a
\end{program}
}

\verb|configure|により，利用者の環境を調査し，適切なコンパイル環境を設定します．

{\small
\begin{program}
$ configure.sh /usr/local/sphere
\end{program}
}

%
\subsection{モジュールの作成とインストール}
\verb|configure|の後，次のコマンドを実行します．

{\small
\begin{program}
$ make
$ sudo make install　または　make install
\end{program}
}

make時に\verb|libimf.so|が見つからないなどのメッセージが出る場合は，ホームディレクトリの\verb|.bash_profile|などにコンパイラのLD\_LIBRARY\_PATHパスを加えておきます．
{\small
\begin{program}
export LD_LIBRARY_PATH=/opt/intel/Compiler/11.1/089/lib:$LD_LIBRARY_PATH
\end{program}
}

%
\subsection{アンインストール}
V-Sphereをアンインストール\index{アンインストール!V-Sphereの@V-Sphereの---}する場合には，インストールしたディレクトリ（configureでオプション指定したディレクトリ：ここでは \verb|/usr/local/sphere|）の\verb|sphere|を削除します．

%
\subsection{倍精度計算モジュール}
単精度計算と倍精度計算では，それぞれ専用のV-Spghereライブラリが必要になり，単精度計算と倍精度計算で異なる精度のモジュールを別々に用意します．
倍精度計算モジュールを生成する場合には，configure時に\verb|--with-real=double|オプションを追加してください．
このオプションは，コンパイルオプションに下記のように\verb|-DREAL_IS_DOUBLE|を追加します．

{\small
\begin{program}
CFLAGS         : -O3 -DREAL_IS_DOUBLE
CXXFLAGS       : -O3 -DREAL_IS_DOUBLE
\end{program}
}

両方必要になる場合には，両方のV-Sphereライブラリを用意しておき，CBCソルバークラスのコンパイル時にリンク先を変更して，コンパイルします．


%%
\hypertarget{tgt:installCBC}{\section{CBCソルバークラスのインストールとコンパイル}}
\label{sec:install CBC}

本節では，ソルバークラスのインストールについて説明します．
提供されるソルバークラスのアーカイブ\verb|CBC_x.x.x.tar.gz|は，ソルバークラスのソースコードです\footnote{CBC\_x.x.x.tar.gzのx.x.xにはリリースバージョン番号が入ります．}．

%%
\subsection{アーカイブの解凍}
{\small
\begin{program}
$ tar xvfz CBC_x.x.x.tar.gz
\end{program}
}

解凍すると，以下のようなファイル構成になります\footnote{doxygenディレクトリについては，doxygenファイルを生成するために必要な設定ファイルのみを提供しています．Confディレクトリ内でmakeを実行すると各ディレクトリにdoxygenファイルが生成されます．}．

{ \small
\begin{program}
CBC_x.x.x
  |
  +- BUILD                        アプリケーションのコンパイル方法のメモ
  +- COPYING                      コピーライト
  +- README                       最初に見るべきファイル
  +- RELEASE                      リリース情報
  |
  +- doc                          ドキュメント
  |   +- cbc_ug.pdf               CBCソルバークラスのユーザガイド
  |   +- vsphere_ug.pdf           V-Sphereのユーザーガイド
  |   +- cbc_examples.pdf         検証の例題集
  |
  +- doxygen                      Doxygenドキュメントディレクトリ
  |   +- CBC                      CBCクラスのドキュメント
  |   +- Conf                     Doxygenファイルを生成するための設定ファイル
  |   +- FB                       FBクラスのドキュメント
  |   +- IP                       Intrinsicクラスのドキュメント
  |
  +- example                      例題
  |   +- 3Dcavity                 三次元のキャビティフロー（立方体領域）
  |   +- LDC112                   辺長１：１：２のキャビティフロー
  |   +- dragon                   ドラゴン形状周りの流れ
  |   +- Duct3D                   管路内流れ
  |   |   +- inner                ドライバ周期境界指定
  |   |   +- outer                外部周期境界指定
  |   +- PMT                      性能測定用パラメータ群
  |   +- SHC1D                    定常1次元熱伝導
  |
  +- src                          ソースコード
  |   +  F_CBC                    CBCクラスのFortranファイル
  |   +- F_CPC                    CPCクラスのFortranファイル
  |   +- F_VOF                    VOFクラスのFortranファイル
  |   +- FB                       FlowBaseクラス（ユーザー定義クラス群）
  |   +- IP                       組み込み例題クラス群
  |   +- PRJ_CBC	                 CBCプロジェクト
  |      +- app                  アプリケーションコンパイルディレクトリ
  |         ...                  他ソースファイル
  |         Makefile
  |      +- bin                  バイナリモジュール格納ディレクトリ
  |      +- CBC                  CBCソルバークラスのソースファイル
  |      |   +- CBC.xml          CBCクラスのコンパイル環境設定
  |      |      ...              他ソースファイル
  |      |      Makefile
  |      +- FB                   非ソルバークラスディレクトリ　FlowBase
  |      |   +- FB.xml           FBクラスのコンパイル環境設定  
  |      |      Makefile
  |      +- IP                   非ソルバークラスディレクトリ　組み込み例題クラス群
  |      |   +- IP.xml           IPクラスのコンパイル環境設定 
  |      |      Makefile
  |      +- Makefile             アプリケーションコンパイル用 Linux/Mac
  |         PRJ_CBC.xml          CBCのコンパイル設定
  +- xsd
     CBC_xxx_FB_xxx.xsd          V-Xpitを用いたパラメータ入力の構造定義ファイル
\end{program}
}
%  |   +- Inside_CBC.pdf           CBCソルバークラスの説明書

%
\subsection{sphPrjToolを用いた簡単なインストールとコンパイル}
既に，並列ライブラリとV-Sphereが正しくインストールされていることを確認します．

まず，sphPrjToolを利用するため，環境変数\verb|SPHEREDIR|を設定します．
下記で\verb|INSTALL_DIR|はV-Sphereのインストールディレクトリを指定します．
次に，\verb|src/PRJ_CBC|ディレクトリで引数にファイル名を渡してsphPrjToolを起動し，プロジェクトのコンパイル設定を利用環境に合わせて再構築します．
localsettingsオプションを指定してresetコマンドを実行すると，sphereライブラリの\verb|config/sph-cfg.xml|に記録されているコンパイル環境情報を元にして，プロジェクト環境情報\verb|PRJ_CBC.xml|を再設定します．

{\small
\begin{program}
$ export SPHEREDIR=INSTALL_DIR
$ cd src/PRJ_CBC
$ sphPrjTool PRJ_CBC.xml
sphPrjTool> reset localsettings
sphPrjTool> print
sphPrjTool> save
sphPrjTool> quit
\end{program}
}

上記の設定の後，コンパイルを行う．

{\small
\begin{program}
$ make
\end{program}
}

%
\subsection{アンインストール}
アンインストール\index{アンインストール!SolverClassの@SolverClassの---}は，SolverClassのディレクトリごと削除します．

%
\subsection{並列計算モジュールのコンパイル}
V-Sphereは逐次計算のモジュールと並列計算のモジュールは異なるので，コンパイル時にオプションで切り替えます．
並列計算\index{へいれつけいさん@並列計算}をする場合は，\verb|PRJ_CBC.xml|内に下記の記述を追加するか，sphPrjToolを用いて設定を変更します．
デフォルトでは逐次実行モジュールになっています．

{\small
\begin{program}
$ sphPrjTool PRJ_CBC.xml
sphPrjTool> module parallel
sphPrjTool> print
sphPrjTool> save
sphPrjTool> quit
\end{program}
}

%
\hypertarget{tgt:win_compile}{\subsection{Windowsでのコンパイルと実行}}

%
\subsubsection{プロジェクトの作成}
プロジェクトツール\footnote{C:{\yen}Program Files{\yen}sphere{\yen}bin{\yen}sphPrjTool.exe}を用いWindows用のプロジェクトを作成します．
プロジェクトツールの使用については，V-Sphere\_ug.pdfを参照してください．
プロジェクトツールによって以下のMakefileが生成されます．
提供ファイルのlibxml2, zlib, iconvのインストールパスは\lq\lq C:{\yen}Program Files{\yen}ext\_libs{\yen}\rq\rq 配下になっているので注意してください．

{\small
\begin{program}
PRJ_CBC
  ├─ Makefile.win
  ├─ project_local_settings
  ├─ CBC
  │    └─ Makefile.win
  ├─ FB
  │    └─ Makefile.win
  └─ IP
       └─ Makefile.win
\end{program}
}

%
\subsubsection{コンパイル}
作成した\verb|Makefile.win|を用いてmakeを行います．
コマンドプロンプトから行うが，Visual Studioの\verb|nmake.exe|を使用するので「Visual Studio 2008 コマンド プロンプト」を起動して行います．
「Visual Studio 2008 コマンド プロンプト」は「Visual Studio 2008」―「Visual Studio Tools」メニューの配下にあります．

以下，nmakeによるコンパイルコマンドです．

{\small
\begin{program}
nmake -f Makefile.win
\end{program}
}

%
\subsubsection{CBCの実行}
ソルバの実行は必ずローカルディスクにて実行します．
ネットワークパス（ネットワークドライブ）で行うとエラーとなります\footnote{現時点 \today では原因不明です．}．

以下の設定を行います．
\begin{enumerate}
\item MPICH2のbinフォルダへパスの追加\\
並列実行ではエラーとなりませんが，逐次実行にてエラーとなります．

\item Windowsファイアウォール設定
\verb|sphere.exe|を例外へ追加します．
コントロールパネル-Windowsセキュリティセンター - Windowsファイアウォール-例外に実行を行う\verb|sphere.exe|を登録します．
\end{enumerate}


\paragraph{逐次実行方法}
次のように実行します．


{\small
\begin{program}
$ set PATH=%PATH%;C:\Program Files\MPICH2\bin
$ pwd
D:\work\CBC-1.3.0\example\3Dcavity
$ ..\..\src\PRJ_CBC\bin\sphere.exe cavity.xml
\end{program}
}


\paragraph{並列実行方法：ローカルホストにて実行}
複数のホストマシンにて実行する方法は，V-Sphere ユーザマニュアル「V-SphereUG.pdf」－11. Windows 対応（使用者向け）又はMPICH2のマニュアルを参照してください．

{\small
\begin{program}
$ pwd
D:\work\CBC-1.3.0\example\3Dcavity
$ "C:\Program Files\MPICH2\bin\mpiexec.exe" -np 4 ..\..\src\PRJ_CBC\bin\sphere.exe cavity.xml
\end{program}
}


%%
\hypertarget{tgt:win_opmi_binary}{\subsection{OpenMPIバイナリパッケージを用いたコンパイルと実行}}
OpenMPI 1.5.3よりWindowsバイナリーパッケージ\footnote{OpenMPI\_v1.5.3-2\_win32.exe}が提供されています．
OpenMPIを以下のフォルダにインストールしたと仮定して説明します．
{\small
\begin{program}
	C:\Program Files\OpenMPI
\end{program}
}

%
\paragraph{V-Sphereのコンパイル}
Config.winを変更します（$\ll$で示す\verb|MPICH_DIR, MPICH_LIBS, MPICH_CFLAGS|）.

{\small
\begin{program}
#
# SPHERE - Skeleton for PHysical and Engineering REsearch
#
# Copyright (c) RIKEN, Japan. All right reserved. 2004-2011
#
#

# folder settings
SPHEREDIR=C:\Program Files\sphere
INTELCXX_DIR=C:\Program Files\Intel\Compiler\C++\10.1.021\IA32
INTELFC_DIR=C:\Program Files\Intel\Compiler\Fortran\10.1.021\IA32
MSSDKS_DIR=C:\Program Files\Microsoft SDKs\Windows\v6.0A
MSVS_DIR=C:\Program Files\Microsoft Visual Studio 9.0
MPICH_DIR=C:\Program Files\OpenMPI <<

EXTLIBS_PATH=C:\Program Files\ext_libs
LIBXML2_DIR=$(EXTLIBS_PATH)\libxml2
ZLIB_DIR=$(EXTLIBS_PATH)\zlib
ICONV_DIR=$(EXTLIBS_PATH)\iconv

# flags ssettings
CFLAGS=/O3 /Qprec-div- /c /TP /MT /DWIN32 /D_WIN32 /DSKL_TIME_MEASURED /D_CATCH_BAD_ALLOC
#CXXFLAGS=/fast /c /TP /MD /DWIN32 /D_WIN32
#CXXFLAGS=/O3 /c /TP /MD /DWIN32 /D_WIN32
#CXXFLAGS=/O3 /Qipo /c /TP /MD /DWIN32 /D_WIN32
#CXXFLAGS=/O3 /Qprec-div- /c /TP /MD /DWIN32 /D_WIN32
CXXFLAGS=/O3 /Qprec-div- /c /TP /MT /DWIN32 /D_WIN32 /DSKL_TIME_MEASURED/D_CATCH_BAD_ALLOC
FCFLAGS=/O3 /Qprec-div- /c /TP /MT /DWIN32 /D_WIN32 /DSKL_TIME_MEASURED
F90FLAGS=/O3 /Qprec-div- /c /TP /MT /DWIN32 /D_WIN32 /DSKL_TIME_MEASURED

# libs settings
MPICH_LIBS= libmpi.lib <<
#XML2LIBS=libxml2.lib zlib.lib libm.lib ws2_32.lib
XML2LIBS=libxml2.lib zdll.lib libmmt.lib ws2_32.lib

# include libpath settings
INCLUDES = \
			/I"$(TOP_BUILDDIR)\include" \
			/I"$(LIBXML2_DIR)\include" \
			/I"$(ZLIB_DIR)\include" \
			/I"$(ICONV_DIR)\include"

LDFLAGS = \
		/LIBPATH:"$(INTELCXX_DIR)\lib" \
		/LIBPATH:"$(LIBXML2_DIR)\lib" \
		/LIBPATH:"$(ZLIB_DIR)\lib" \
		/LIBPATH:"$(ICONV_DIR)\lib"

MPICH_CFLAGS=/I"$(MPICH_DIR)\include" /DOMPI_IMPORTS <<
MPICH_LDFLAGS=/LIBPATH:"$(MPICH_DIR)\lib"

# exec settings
CC="$(INTELCXX_DIR)\bin\icl.exe"
CXX="$(INTELCXX_DIR)\bin\icl.exe"
FC="$(INTELFC_DIR)\bin\ifort.exe"
F90="$(INTELFC_DIR)\bin\ifort.exe"
AR="$(INTELCXX_DIR)\bin\xilib.exe"
LINK="$(INTELCXX_DIR)\bin\xilink.exe"
MANF_TOOL=mt.exe
CP=copy
RM=del /F /Q

# environments
PATH=$(MSVS_DIR)\Common7\IDE;$(MSVS_DIR)\VC\bin;$(MSSDKS_DIR)\bin;$(PATH);
INCLUDE=$(MSVS_DIR)\VC\INCLUDE;$(MSSDKS_DIR)\include;$(INCLUDE)
LIB=$(MSVS_DIR)\VC\LIB;$(MSSDKS_DIR)\lib;$(LIB)
LIBPATH=$(MSVS_DIR)\VC\LIB;$(LIBPATH)

\end{program}
}


\begin{enumerate}
\item OpenMPIのインストールパスの変更
\item \verb|libmpi.lib|の変更
\item OMPI\_IMPORTSマクロの追加
\end{enumerate}

V-Sphereをコンパイルし，作成したライブラリとインクルードファイルをC:{\yen}program files{\yen}sphere\_ompiに配置します．

{\small
\begin{program}
$ nmake /f Makefile.win
\end{program}
}

%
\paragraph{ソルバCBCのコンパイル}
\verb|project_local_settings|を変更します．\\
\verb|SPHEREDIR, MPICH_DIR, MPICH_CFLAGS, MPICH_LDFLAGS, MPICH_LIBS, SPHERE_CFLAGS, SPHERE_LDFLAGS|

{\small
\begin{program}
#
# SPHERE - Skeleton for PHysical and Engineering REsearch
#
# Copyright (c) RIKEN, Japan. All right reserved. 2004-2010
#
#
CC=gcc
CFLAGS=-g -O2
CXX="C:\Program Files\Intel\Compiler\C++\10.1.021\IA32\Bin\icl.exe"
CXXFLAGS=/O3 /Qipo /Qprec-div-
FC=f95
FCFLAGS=-g -O2
F90="C:\Program Files\Intel\Compiler\Fortran\10.1.021\IA32\Bin\ifort.exe"
F90FLAGS=/O3 /Qipo /Qprec-div-
LDFLAGS=/LIBPATH:"C:\Program Files\Intel\Compiler\Fortran\10.1.021\IA32\Lib"
LIBS=ws2_32.lib libifport.lib libmmt.lib libifcoremt.lib
SPH_USR_DEF_LIBS=
UDEF_OPT=-DNON_POLYLIB -DNON_CUTLIB
UDEF_INC_PATH=
UDEF_LIB_PATH=
UDEF_LIB_UPPER=
UDEF_LIB_LOWER=
SPHEREDIR=C:\Program Files\sphere_ompi <<
SPH_DEVICE=IA32_WIN
MPICH_DIR=C:\Program Files\OpenMPI <<
MPICH_CFLAGS=/I"C:\Program Files\OpenMPI\include" <<
MPICH_LDFLAGS=/LIBPATH:"C:\Program Files\OpenMPI\lib" <<
MPICH_LIBS=libmpi.lib <<
XML2FLAGS=/I"C:\Program Files\ext_libs\libxml2\include" /I"C:\Program Files\ext_libs\iconv\include"
XML2LIBS=libxml2.lib zdll.lib
SPHERE_CFLAGS=/DSKL_TIME_MEASURED /D_CATCH_BAD_ALLOC /I"C:\Program Files\sphere_ompi\include" <<
SPHERE_LDFLAGS=/LIBPATH:"C:\Program Files\sphere_ompi\lib" <<
SPHERE_LIBS=libsphapp.lib libsphbase.lib libsphfio.lib libsphdc.lib libsphcrd.lib libsphcfg.lib 
            libsphftt.lib libsphvcar.lib
REALOPT=
CXXFLAGS_DEF=/c /TP /MT /DWIN32 /D_WIN32
F90FLAGS_DEF=/c /MT
SPHERE_DEFINE=/DSKL_TIME_MEASURED /D_CATCH_BAD_ALLOC
ZLIB_DIR=C:\Program Files\ext_libs\zlib
ZLIB_LDFLAGS=/LIBPATH:"C:\Program Files\ext_libs\zlib\lib"
INTELCXX_DIR=
INTELF90_DIR=
LIBXML2_DIR=C:\Program Files\ext_libs\libxml2
MSSDKS_DIR=C:\Program Files\Microsoft SDKs\Windows\v6.0A
MSVS_DIR=C:\Program Files\Microsoft Visual Studio 9.0
INTELCXXBIN_DIR=C:\Program Files\Intel\Compiler\C++\10.1.021\IA32\Bin
INTELF90BIN_DIR=C:\Program Files\Intel\Compiler\Fortran\10.1.021\IA32\Bin
INTELCXXLIB_DIR=C:\Program Files\Intel\Compiler\C++\10.1.021\IA32\lib
INTELF90LIB_DIR=C:\Program Files\Intel\Compiler\Fortran\10.1.021\IA32\Lib
ICONV_DIR=C:\Program Files\ext_libs\iconv
XML2LDFLAGS=/LIBPATH:"C:\Program Files\ext_libs\libxml2\lib" 
            /LIBPATH:"C:\Program Files\ext_libs\iconv\lib"
SPH_EXTERNAL_HEADER_PATH=/I..\..\Cutlib_2_0_0\include /I..\..\FB /I..\..\F_CBC /I..\..\IP 
                         /I..\..\Polylib_2_0_2\include 
SPH_PARA_MODULE=MPI
\end{program}
}


\begin{enumerate}
\item OpenMPI用のV-Sphereのパスの変更
\item OpenMPIのインストールパスの変更
\item \verb|libmpi.lib|の変更
\end{enumerate}

ソルバCBCをコンパイルします．
{\small
\begin{program}
$ pwd
D:\work\CBC-1.3.0\src\PRJ_CBC
$ nmake -f Makefile.win
\end{program}
}

%
\paragraph{ソルバCBCの実行}
\verb|sphere.exe|を実行する前にOpenMPIへのパスを追加します．

{\small
\begin{program}
$ set PATH=%PATH%;C:\Program Files\OpenMPI\bin
\end{program}
}

ローカルホストにて，\verb|mpirun.exe|により並列実行を行います\footnote{逐次実行はエラーとなっています．}．
{\small
\begin{program}
$ pwd
D:\work\CBC-1.3.0\example\3Dcavity
$ "C:\Program Files\OpenMPI\bin\mpirun.exe" -np 4  ..\..\src\PRJ_CBC\bin\sphere.exe cavity.xml
\end{program}
}

