\section{CBC SolverClassのインストール}

%
\subsection{インストール}

%
\subsubsection{標準インストール}
\verb|sphPrjTool|を使ってインストール．
あるプラットホームで開発したソースコードを異なるプラットホームでコンパイルする場合には，環境変数やV-Sphereのインストールディレクトリなどの違いにより多くパラメータの再設定が必要になる．
煩雑な修正を避けるために，\verb|sphPrjTool|にはresetコマンド\index{reset}が用意されている．
resetコマンドは，V-Sphereがインストールされているディレクトリ配下の\verb|~/config/sph-cfg.xml|の内容\footnote{プラットホーム環境設定情報}を参照する．
このため，resetコマンドを実行する前にV-Sphereのインストールディレクトリを環境変数\verb|SPHEREDIR|で指定する．

{\small
\begin{program}
$ export SPHEREDIR=INSTALL_DIR
$ sphPrjTool PRJ_CBC.xml

sphPrjTool> reset localsettings
sphPrjTool> print
sphPrjTool> save
sphPrjTool> quit
\end{program}
}

この作業により，\verb|project_local_settings|が上書きされるので，以下のコマンドによりソルバーをコンパイルする．
{\small
\begin{program}

$ make allclean
$ make depend
$ make
\end{program}
}

必要に応じて，プロジェクトコンパイル環境設定ファイルを編集する．
\begin{itemize}
\item 使用環境に応じた適切なコンパイルオプションを指定する．
\item LDFLAGSののLibraryのPATHも異なっていたら、適切なパスに変更する．
\item libxml2\\
libxml2\index{libxml2}ライブラリに関連する環境変数については，XML2LIBSとXML2FLAGSを，それぞれ次のコマンドにより得られる出力をそのまま記述する．

{\small
\begin{program}
$ xml2-config --libs
$ xml2-config --cflags
\end{program}
}

\end{itemize}


%
\section{各種プラットホームにおけるCBCのコンパイル}

%
\subsection{RICC, FOCUS}
RICC~\cite{RICC}とFOCUS~\cite{FOCUS}は，Intel製CPUのクラスタで，標準的なインストール手順を実行．

%
\subsection{BlueGene/L}
IBM BlueGene/L\index{BlueGene}でのコンパイルについて説明する．コンパイル環境は，IBM XLFortran, XLC++コンパイラ，クロスコンパイルである．
クロスコンパイラ\index{クロスコンパイラ}のため，sphPrjTool\index{sphPrjTool}は使用できないので，他の環境でプロジェクトを作成して持ってくる．
\vspace{\baselineskip}

\subparagraph{project\_local\_settingsファイルの編集}
変更箇所は以下のとおり．\footnote{SPHEREDIR, SPHERE\_CFLAGS, SPHERE\_LDFLAGSは，「/gfs1/user/sphere/Vsphere\_1\_7\_2\_lib」を指定したsphereライブラリインストールディレクトリ（INSTALLDIR）に置き換えること．XML2FLAGS, XML2LIBSは，「/gfs1/user/XML2」を指定したlibxml2インストールディレクトリ（--prefix）に置き換えること．}

\begin{indentation}{3zw}{0zw}
\small
\begin{verbatim}
CC=blrts_xlc
CFLAGS=-qarch=440 -qtune=440 -O3
CXX=blrts_xlC
CXXFLAGS=-qarch=440 -qtune=440 -O3 -D_NON_P4_DEVICE_ 
FC=blrts_xlf
FCFLAGS=-qarch=440 -qtune=440 -O3 -qextname
F90=blrts_xlf90
F90FLAGS=-qarch=440 -qtune=440 -O3 -qextname
LDFLAGS=-L/bgl/BlueLight/ppcfloor/bglsys/lib -L/opt/ibmcmp/xlf/bg/10.1/blrts_lib
LIBS=-lmsglayer.rts -lrts.rts -ldevices.rts -lmass -lmassv -lxlf90
SPH_USR_DEF_LIBS=
SPHEREDIR=/gfs1/user/sphere/Vsphere_1_7_2_lib
SPH_DEVICE=Linux
MPICH_DIR=/bgl/BlueLight/ppcfloor/bglsys
MPICH_CFLAGS=-I/bgl/BlueLight/ppcfloor/bglsys/include
MPICH_LDFLAGS=-L/bgl/BlueLight/ppcfloor/bglsys/lib
MPICH_LIBS=-lmpich.rts
XML2FLAGS=-I/gfs1/user/XML2/include/libxml2
XML2LIBS=-L/gfs1/user/XML2/lib -lxml2
SPHERE_CFLAGS=-DSKL_TIME_MEASURED -D_CATCH_BAD_ALLOC 
              -I/gfs1/user/sphere/Vsphere_1_7_2_lib/include
SPHERE_LDFLAGS=-L/gfs1/user/sphere/Vsphere_1_7_2_lib/lib
SPH_PARA_MODULE=MPI
\end{verbatim}
\end{indentation}


%
\subsection{AMD Opteron}
本節では，AMD Opteron\index{AMD Opteron}上でのsphereコンパイルについて述べる．

sphPrjTool\index{sphPrjTool}を使用してプロジェクトを作成する．sphPrjToolでは，以下のコマンドでLIBSを指定する．PGI Compilerの場合，\\

\begin{indentation}{3zw}{0zw}
\small
\begin{verbatim}
sphPrjTool> env LIBS "-lpgf90 -lpgf90_rpm1 -lpgf902 -lpgftnrtl"
\end{verbatim}
\end{indentation}

Intel Compilerの場合，project\_local\_settingsでのコンパイルオプションは"-O3"のみを指定する．


%
\subsection{QUEST}
\label{sec:install_quest}
本節では，理化学研究所のQuestシステム\footnote{Questシステムの詳細については，VPN経由で，http://quest.q.riken.jp}（PFU製RG1000$\times$64台, 1024node, 1CPU/node, 2cores/CPU, 2GB/node, GE）環境でのコンパイルについて示す．
Questシステムでは幾種類かのMPIライブラリが利用可能なので，各ライブラリに合わせてコンパイルを行う．下記に，インストールシェルのサンプルを示す．
PRJ\_CBC.xmlを次のように設定する．

\begin{indentation}{3zw}{0zw}
\small
\begin{verbatim}
<?xml version="1.0"?>
<SphereProject>
  <Param name="prj_name" dtype="STRING" value="PRJ_CBC"/>
  <Elem name="Environment">
    <Param name="CC" dtype="STRING" value="/opt/intel/Compiler/11.0/081/bin/intel64/icc"/>
    <Param name="CFLAGS" dtype="STRING" value="-O3"/>
    <Param name="CXX" dtype="STRING" value="/opt/intel/Compiler/11.0/081/bin/intel64/icpc"/>
    <Param name="CXXFLAGS" dtype="STRING" value="-O3"/>
    <Param name="FC" dtype="STRING" value="/opt/intel/Compiler/11.0/081/bin/intel64/ifort"/>
    <Param name="FCFLAGS" dtype="STRING" value="-O3 -r8"/>
    <Param name="F90" dtype="STRING" value="/opt/intel/Compiler/11.0/081/bin/intel64/ifort"/>
    <Param name="F90FLAGS" dtype="STRING" value="-O3 -r8"/>
    <Param name="LDFLAGS" dtype="STRING" value="-L/opt/intel/Compiler/11.0/081/lib/intel64"/>
    <Param name="LIBS" dtype="STRING" value="-lifport -lifcore"/>
    <Param name="SPH_USR_DEF_LIBS" dtype="STRING" value=""/>
    <Param name="SPHEREDIR" dtype="STRING" value="/gfs1/keno/SPHERE/bin/vsph175_dbl"/>
    <Param name="SPH_DEVICE" dtype="STRING" value="IA64_Linux"/>
    <Param name="MPICH_DIR" dtype="STRING" value="/usr/local/openmpi/intel"/>
    <Param name="MPICH_CFLAGS" dtype="STRING" value="-I/usr/local/openmpi/intel/include"/>
    <Param name="MPICH_LDFLAGS" dtype="STRING" value="-L/usr/local/openmpi/intel/lib"/>
    <Param name="MPICH_LIBS" dtype="STRING" value="-lmpi"/>
    <Param name="XML2FLAGS" dtype="STRING" value="-I/usr/include/libxml2"/>
    <Param name="XML2LIBS" dtype="STRING" value="-lxml2 -lz -lpthread -lm"/>
    <Param name="SPHERE_CFLAGS" dtype="STRING" value="-DSKL_TIME_MEASURED 
                 -D_CATCH_BAD_ALLOC -I/gfs1/keno/SPHERE/bin/vsph175_dbl/include"/> \
    <Param name="SPHERE_LDFLAGS" dtype="STRING" \
                 value="-L/gfs1/keno/SPHERE/bin/vsph175_dbl/lib"/>
    <Param name="SPHERE_LIBS" dtype="STRING" value="-lsphapp -lsphbase -lsphls -lsphfio \
                 -lsphdc -lsphcrd -lsphcfg -lsphftt -lsphvcar"/>
    <Param name="REALOPT" dtype="STRING" value="-DREAL_IS_DOUBLE"/>
    <Param name="SPH_EXTERNAL_HEADER_PATH" dtype="STRING" value="../../FB"/>
    <Param name="SPH_EXTERNAL_HEADER_PATH" dtype="STRING" value="../../IP"/>
    <Param name="SPH_PARA_MODULE" dtype="STRING" value="MPI"/>
    <Param name="SPH_PLS_FNAME" dtype="STRING" value="../project_local_settings"/>
  </Elem>
  <Elem name="SolverClass">
    <Elem name="CBC">
    </Elem>
  </Elem>
  <Elem name="NonSolverClass">
    <Elem name="IP">
    </Elem>
    <Elem name="FB">
    </Elem>
  </Elem>
</SphereProject>
\end{verbatim}
\end{indentation}

%
\subsection{Windows}
\label{sec:install_win}
V-Sphere::CBC Version 1.4.4とV-Sphere::FlowBase Version 1.8.4の場合のWindowsXPにおけるコンパイル手順を以下に示す．

\subparagraph{sphPrjToolでのリセット}
Windows上でプロジェクトツールを実行して、"reset localsettings"を行う．

\begin{indentation}{3zw}{0zw}
\small
\begin{verbatim}
$ export SPHEREDIR=INSTALL_DIR
$ sphPrjTool PRJ_CBC.xml
sphPrjTool> reset localsettings
sphPrjTool> print
sphPrjTool> save
sphPrjTool> quit
\end{verbatim}
\end{indentation}

この作業により，project\_local\_settingsが上書きされ，Makefile.winが生成される．
上記作業を行った後に，nmake -f Makefile.win を実行すると，Windows上でコンパイルが可能になる．

\subparagraph{コンパイル}
カレントディレクトリをSolverClassとして，以下のようにコンパイルを実施する．\\
{\small
\begin{verbatim}
$PRJ_CBC> nmake -f Makefile.win
\end{verbatim}
}

実行モジュールsphere.exeが生成され，PRJ\_CBC/binディレクトリにコピーされる．
\vspace{\baselineskip}


Windows\index{Windows}環境ではDOSプロンプトを用いてコンパイルを行う．
ただし，DOSプロンプトの環境で以下のパスが設定されている必要がある．
DOSプロンプト上でsetコマンドを用いて以下が環境変数PATHに設定されていることを確認のこと．

\begin{description}
\item[・] libxml2ライブラリのパス
\item[・] zlibライブラリのパス
\item[・] iconvライブラリのパス
\end{description}

\vspace{3mm}

詳細はV-SphereのWindowsマニュアル（18\_windows.pdf）を参照．
アクセサリメニューにあるDOSプロンプトには，Visual Studio\index{Visual Studio}やIntel Compilerの環境情報が登録されていない場合がある．
その際には，Visual StudioもしくはIntel Compilerに付属しているDOSプロンプトを使用すること．\\


\subparagraph{Intel Compiler 11.xへの対応}
表\ref{tbl:change_local_setting_win}の環境変数について修正を行う．

\begin{table}[htdp]
\small
\caption{Intel Compiler 11.xに対する変更}
\begin{center}
\begin{tabular}{lll} \toprule
  & & 修正内容\\ \midrule
1 & 修正前 & \verb|CXX="C:\Program Files\Intel\Compiler\C++\10.1.021\IA32\bin\icl.exe"|\\
  & 修正後 & \verb|CXX="C:\Program Files\Intel\Compiler\11.0\066\cpp\bin\ia32\icl.exe"|\\ \hline
2 & 修正前 & \verb|F90="C:\Program Files\Intel\Compiler\Fortran\10.1.021\IA32\bin\ifort.exe"|\\
  & 修正後 & \verb|F90="C:\Program Files\Intel\Compiler\11.0\066\fortran\bin\ia32\ifort.exe"|\\ \hline
3 & 修正前 & \verb|LDFLAGS=/LIBPATH:"C:\Program Files\Intel\Compiler\Fortran\10.1.021\IA32\lib"|\\
  & 修正後 & \verb|LDFLAGS=/LIBPATH:"C:\Program Files\Intel\Compiler\11.0\066\fortran\lib\ia32"|\\ \hline
4 & 修正前 & \verb|INTELF90_DIR=C:\Program Files\Intel\Compiler\Fortran\10.1.021\IA32|\\
  & 修正後 & \verb|INTELF90_DIR=C:\Program Files\Intel\Compiler\11.0\066\fortran|\\ \hline
5 & 修正前 & \verb|INTELCXX_DIR=C:\Program Files\Intel\Compiler\C++\10.1.021\IA32|\\
  & 修正後 & \verb|INTELCXX_DIR=C:\Program Files\Intel\Compiler\11.0\066\cpp|\\ \bottomrule
\end{tabular}
\end{center}
\label{tbl:change_local_setting_win}
\end{table}

\subparagraph{Makefile.winの修正}
表\ref{tbl:change_make_win}の環境変数について修正を行う．

\begin{table}[htdp]
\small
\caption{Intel Compiler 11.xに対する変更}
\begin{center}
\begin{tabular}{lll} \toprule
  & & 修正内容\\ \midrule
1 & 修正前 & \verb|AR = "$(INTELCXX_DIR)\bin\xilib.exe"|\\
  & 修正後 & \verb|AR = "$(INTELCXX_DIR)\bin\ia32\xilib.exe"|\\ \hline
2 & 修正前 & \verb|INTEL_LINK = "$(INTELCXX_DIR)\bin\xilink.exe"|\\
  & 修正後 & \verb|INTEL_LINK = "$(INTELCXX_DIR)\bin\ia32\xilink.exe"|\\ \bottomrule
\end{tabular}
\end{center}
\label{tbl:change_make_win}
\end{table}

なお，Makefile.winファイルはプロジェクトフォルダ直下，およびFBフォルダ，CBCフォルダに存在するので，すべてのMakefile.winファイルに対して上記の修正を行う．

%
\subsection{Windowsの実行モジュール}
\label{sec:win_binary}

Windows版のバイナリパッケージのインストールについて説明する．
Windows版のバイナリパッケージはCD-ROM1のディスクイメージにより提供する．
\begin{verbatim}
CD-ROM1
+- CBC
    +- doc
    |   +- CBC_for_win_manual.pdf     CBCインストールマニュアル
    |   +- cbc_UG.pdf                 CBCユーザガイド
    |   +- Sphere_UG.pdf              V-Sphereユーザガイド
    +- bin
        +- bin.zip                    CBC実行モジュール（sphere.exe）
\end{verbatim}


\subsubsection{インストール手順}

\begin{enumerate}
\item Visual C++ 2005 SP1 再頒布可能パッケージのインストール\\
vcredist\_x86.exe
\item WindowsInstaller 3.1 Redistributableのインストール \\
WindowsInstaller-KB893803-v2-x86.exe
\item .NET Framework Version 3.5 再頒布可能パッケージのインストール\\
dotNetFx35setup.exe
\item MPICH2のインストール\\
mpich2-1.2.1p1-win-ia32.msi
\item libxml2のインストール\\
libxml2-2.6.32+.win32
\item iconvのインストール\\
iconv-1.9.2.win32
\item zlibのインストール\\
zlib-1.2.3.win32
\item 環境変数の設定\\
システム環境変数"Path"にlibxml2, iconv, zlibの各binフォルダを登録する．また，MPICH2のbinフォルダも登録しておくと便利．
\item ソルバのインストール\\
CD-ROM1の\verb|CBC\bin\bin.zip|を展開してできるフォルダ"bin"を任意の位置(例えば\verb|c:\Program Files|)にフォルダ"CBC"を作成して，"CBC"フォルダは配下に展開した   "bin"フォルダごと移動する．このbinフォルダも環境変数Pathに登録しておくと便利．
\end{enumerate}
